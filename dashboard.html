<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FurnicoHub | Seller Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    
    <!-- Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <style>
        :root { --primary: #795548; --bg: #F4F7FC; --white: #fff; --green: #2ED573; --red: #FF4757; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); padding-bottom: 80px; }
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        
        /* Login Screen */
        .login-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; background: white; }
        
        /* Navbar */
        .top-nav { background: var(--white); padding: 15px; position: sticky; top: 0; z-index: 999; display: flex; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .brand { font-weight: 800; color: var(--primary); font-size: 1.2rem; }
        
        /* Bottom Tabs */
        .tabs { position: fixed; bottom: 0; width: 100%; background: white; display: flex; overflow-x: auto; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; gap: 5px; }
        .tab-btn { padding: 8px 12px; border-radius: 12px; border: none; background: transparent; color: #777; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; min-width: 60px; cursor: pointer; flex-shrink: 0; }
        .tab-btn i { font-size: 1.2rem; margin-bottom: 4px; }
        .tab-btn.active { color: var(--primary); background: #efebe9; font-weight: 600; }

        /* Container */
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        
        /* Forms */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #555; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-green { background: var(--green); color: white; }
        
        /* POS & Products */
        .product-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .product-item img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 10px; }
        
        /* Badge */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; }
        .bg-pending { background: #fff3cd; color: #856404; }
        .bg-verified { background: #d4edda; color: #155724; }

        /* Verification Area */
        .verify-box { background: #fff8e1; border: 1px solid #ffe082; padding: 15px; border-radius: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- 1. LOGIN VIEW -->
    <div id="login-view" class="login-screen">
        <img src="logo.png" style="width:100px; margin-bottom:20px;">
        <h1>Seller Portal</h1>
        <p>Manage your furniture shop, POS, and Online Webpage.</p>
        <button class="btn btn-primary" onclick="googleLogin()">Login with Gmail</button>
        <a href="index.html" style="margin-top:20px; color:var(--primary)">Back to Home</a>
    </div>

    <!-- 2. DASHBOARD VIEW -->
    <div id="main-view" class="hidden">
        <nav class="top-nav">
            <div class="brand"><i class="fa-solid fa-couch"></i> <span id="shop-name-disp">Loading...</span></div>
            <button onclick="auth.signOut()" style="background:none; border:none; color:var(--red)"><i class="fa-solid fa-power-off"></i></button>
        </nav>

        <div id="content-area" class="container"></div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('pos')"><i class="fa-solid fa-cash-register"></i> POS</button>
            <button class="tab-btn" onclick="switchTab('marketplace')"><i class="fa-solid fa-store"></i> Market</button>
            <button class="tab-btn" onclick="switchTab('products')"><i class="fa-solid fa-box-open"></i> Items</button>
            <button class="tab-btn" onclick="switchTab('profile')"><i class="fa-solid fa-user-gear"></i> Profile</button>
            <button class="tab-btn" onclick="switchTab('verify')"><i class="fa-solid fa-certificate"></i> Verify</button>
            <button class="tab-btn" onclick="switchTab('webpage')"><i class="fa-solid fa-globe"></i> Web</button>
            <button class="tab-btn" onclick="switchTab('orders')"><i class="fa-solid fa-clipboard-list"></i> Orders</button>
        </div>
    </div>

<script>
    // Config
    const firebaseConfig = { apiKey: "AIzaSyCbqz4vsik5tiuAUvIL_-FiquhrZcXX0N0", authDomain: "furnicohub.firebaseapp.com", projectId: "furnicohub", storageBucket: "furnicohub.firebasestorage.app", messagingSenderId: "395576125006", appId: "1:395576125006:web:a848f68053c69409ddc51f", measurementId: "G-WE0RETCVTX" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let user = null;
    let userData = {};
    let tempImages = [];

    // Auth Logic
    auth.onAuthStateChanged(async u => {
        if (u) {
            user = u;
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            
            // Check Profile
            const doc = await db.collection('users').doc(user.uid).get();
            if(doc.exists) {
                userData = doc.data();
                if(userData.role !== 'seller') { 
                    alert("Account exists as Customer. Please use a different email for Seller.");
                    auth.signOut();
                    return;
                }
                document.getElementById('shop-name-disp').innerText = userData.shopName || "FurnicoHub";
                // Default Tab Logic
                if(!userData.profileSaved) switchTab('profile');
                else switchTab('pos');
            } else {
                // First Time Seller
                userData = { role: 'seller', profileSaved: false, isVerified: false, products: [] };
                await db.collection('users').doc(user.uid).set(userData);
                switchTab('profile');
            }
        } else {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('main-view').classList.add('hidden');
        }
    });

    function googleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => alert(e.message));
    }

    // Tab Router
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event?.currentTarget?.classList.add('active');
        
        const content = document.getElementById('content-area');
        content.innerHTML = ''; 

        if(tab === 'profile') renderProfile(content);
        else if(tab === 'verify') renderVerify(content);
        else if(tab === 'products') renderProducts(content);
        else if(tab === 'pos') renderPOS(content);
        else if(tab === 'marketplace') renderMarketplace(content);
        else if(tab === 'webpage') renderWebpage(content);
        else if(tab === 'orders') renderOrders(content);
    }

    // --- 1. PROFILE ---
    function renderProfile(target) {
        const d = userData;
        const disabled = d.isVerified ? 'disabled' : ''; // Lock only if verified
        
        target.innerHTML = `
            <div class="card">
                <h3>Shop Profile ${d.isVerified ? '<span class="badge bg-verified">Verified</span>' : ''}</h3>
                <p style="color:red; font-size:0.8rem;">${d.isVerified ? 'Profile is Verified & Locked.' : 'You can edit until verified.'}</p>
                
                <div class="input-group">
                    <label>Shop Logo</label>
                    <input type="file" ${disabled} onchange="uploadImage(this, 'logo')">
                    ${d.logo ? `<img src="${d.logo}" style="width:60px; height:60px; border-radius:50%; margin-top:5px;">` : ''}
                </div>
                <div class="input-group"><label>Shop Name *</label><input id="p-name" value="${d.shopName||''}" ${disabled}></div>
                <div class="input-group"><label>Address *</label><textarea id="p-addr" ${disabled}>${d.address||''}</textarea></div>
                <div class="input-group"><label>Owner Full Name *</label><input id="p-owner" value="${d.ownerName||''}" ${disabled}></div>
                <div class="input-group"><label>NIC Number *</label><input id="p-nic" value="${d.nic||''}" ${disabled}></div>
                <div class="input-group"><label>Phone 01 *</label><input type="tel" id="p-ph1" value="${d.phone1||''}" ${disabled}></div>
                <div class="input-group"><label>Phone 02 (Optional)</label><input type="tel" id="p-ph2" value="${d.phone2||''}" ${disabled}></div>
                <div class="input-group"><label>WhatsApp Number *</label><input type="tel" id="p-wa" value="${d.whatsapp||''}" ${disabled} placeholder="07xxxxxxxx"></div>
                
                ${!d.isVerified ? `<button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>` : ''}
            </div>
            
            <div class="card">
                <h3>Open/Close Times</h3>
                <div class="input-group"><label>Opening Hours</label><input id="p-hours" value="${d.hours||'8 AM - 8 PM'}"></div>
                <button class="btn btn-primary" onclick="saveHours()">Update Hours</button>
            </div>
        `;
    }

    async function saveProfile() {
        const waInput = document.getElementById('p-wa').value;
        const formattedWa = waInput.startsWith('0') ? '+94' + waInput.substring(1) : waInput;

        const newData = {
            shopName: document.getElementById('p-name').value,
            address: document.getElementById('p-addr').value,
            ownerName: document.getElementById('p-owner').value,
            nic: document.getElementById('p-nic').value,
            phone1: document.getElementById('p-ph1').value,
            phone2: document.getElementById('p-ph2').value,
            whatsapp: formattedWa,
            profileSaved: true
        };

        if(!newData.shopName || !newData.ownerName || !newData.nic || !newData.whatsapp) return alert("Fill required fields!");

        await db.collection('users').doc(user.uid).update(newData);
        userData = { ...userData, ...newData };
        alert("Profile Saved!");
        if(!userData.isVerified) switchTab('pos');
    }
    
    function saveHours() {
        const h = document.getElementById('p-hours').value;
        db.collection('users').doc(user.uid).update({ hours: h }).then(() => alert("Hours updated"));
    }

    // --- 2. VERIFY ---
    function renderVerify(target) {
        if(userData.isVerified) {
            target.innerHTML = `<div class="card" style="text-align:center; color:green;"><i class="fa-solid fa-circle-check fa-3x"></i><h3>You are Verified!</h3><p>Your shop has the trusted badge.</p></div>`;
            return;
        }
        target.innerHTML = `
            <div class="card">
                <h3>Get Verified (Rs. 5000 One-time)</h3>
                <p>Build customer trust. Verified shops get a badge and better visibility.</p>
                
                <div class="verify-box">
                    <p><b>Step 1:</b> Download Profile Details.</p>
                    <button class="btn" style="background:#fff; border:1px solid #333;" onclick="printProfile()">Download/Print</button>
                    
                    <p style="margin-top:10px;"><b>Step 2:</b> Get it certified by Grama Niladhari or JP (Rubber stamp required).</p>
                    
                    <p><b>Step 3:</b> Pay Rs. 5000 to:</p>
                    <ul>
                        <li><b>Bank:</b> Commercial Bank, Homagama</li>
                        <li><b>Account:</b> 8750053306</li>
                        <li><b>Name:</b> COLOMBAGE SD</li>
                    </ul>
                    
                    <p><b>Step 4:</b> Upload Proof (Certified Doc & Payment Slip).</p>
                    <input type="file" class="input-group" onchange="uploadImage(this, 'verifyDoc')">
                </div>
                
                <button class="btn btn-green" onclick="submitVerify()">Submit for Review</button>
                <p style="font-size:0.8rem; margin-top:10px;">Support: 0703150742 | Sahan Colombage</p>
            </div>
        `;
    }

    async function submitVerify() {
        if(!userData.temp_verifyDoc) return alert("Please upload proof image first.");
        await db.collection('admin_requests').add({
            uid: user.uid,
            shopName: userData.shopName,
            proof: userData.temp_verifyDoc,
            timestamp: new Date().toISOString(),
            status: 'pending'
        });
        alert("Verification Submitted! Admin will review.");
    }
    
    function printProfile() {
        const w = window.open();
        w.document.write(`<h3>${userData.shopName} - Profile</h3><p>Owner: ${userData.ownerName}</p><p>NIC: ${userData.nic}</p><p>Address: ${userData.address}</p><script>window.print()<\/script>`);
    }

    // --- 3. PRODUCTS ---
    function renderProducts(target) {
        tempImages = [null, null, null];
        target.innerHTML = `
            <div class="card">
                <h3>Add/Edit Product</h3>
                <div class="input-group"><label>Category</label><select id="prod-cat"><option>Living Room</option><option>Bedroom</option><option>Dining</option><option>Office</option></select></div>
                <div class="input-group"><label>Sub Category</label><input id="prod-sub" placeholder="e.g. Sofa, Bed"></div>
                <div class="input-group"><label>Product Name</label><input id="prod-name"></div>
                <div class="input-group"><label>Price (LKR)</label><input type="number" id="prod-price"></div>
                <div class="input-group"><label>Promo Text (Short)</label><input id="prod-promo"></div>
                <div class="input-group"><label>Description</label><textarea id="prod-desc"></textarea></div>
                
                <div class="input-group">
                    <label>Images (Max 3)</label>
                    <div class="flex" style="gap:10px">
                        <input type="file" onchange="uploadImage(this, 'prod', 0)">
                        <input type="file" onchange="uploadImage(this, 'prod', 1)">
                        <input type="file" onchange="uploadImage(this, 'prod', 2)">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addProduct()">Save Product</button>
            </div>
            
            <h3>My Inventory</h3>
            <div id="inventory-list">
                ${(userData.products || []).map((p, idx) => `
                    <div class="card product-item">
                        <img src="${p.images[0]}">
                        <div style="flex:1;">
                            <b>${p.name}</b><br>Rs. ${p.price}
                        </div>
                        <button onclick="deleteProduct(${idx})" style="color:red; background:none; border:none;"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    async function addProduct() {
        // Filter out nulls
        const validImgs = tempImages.filter(i => i !== null);
        if(validImgs.length === 0) return alert("At least 1 image required.");
        
        const newP = {
            id: Date.now().toString(),
            category: document.getElementById('prod-cat').value,
            subCategory: document.getElementById('prod-sub').value,
            name: document.getElementById('prod-name').value,
            price: document.getElementById('prod-price').value,
            promoText: document.getElementById('prod-promo').value,
            description: document.getElementById('prod-desc').value,
            images: validImgs
        };
        
        const products = [...(userData.products || []), newP];
        await db.collection('users').doc(user.uid).update({ products });
        userData.products = products;
        alert("Product Saved!");
        renderProducts(document.getElementById('content-area'));
    }
    
    async function deleteProduct(idx) {
        if(!confirm("Delete item?")) return;
        userData.products.splice(idx, 1);
        await db.collection('users').doc(user.uid).update({ products: userData.products });
        renderProducts(document.getElementById('content-area'));
    }

    // --- 4. POS (Smart Point of Sale) ---
    function renderPOS(target) {
        target.innerHTML = `
            <div class="card">
                <h3>Smart POS</h3>
                <div class="input-group">
                    <label>Select Product</label>
                    <select id="pos-select">
                        <option value="">-- Choose --</option>
                        ${(userData.products || []).map(p => `<option value="${p.name}|${p.price}">${p.name} - Rs. ${p.price}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group"><label>Customer Name</label><input id="pos-cname"></div>
                <div class="input-group"><label>Discount (LKR)</label><input type="number" id="pos-disc" value="0"></div>
                
                <button class="btn btn-green" onclick="generateInvoice()">Generate & Print Invoice</button>
            </div>
        `;
    }

    function generateInvoice() {
        const sel = document.getElementById('pos-select').value;
        if(!sel) return alert("Select a product");
        const [pName, pPrice] = sel.split('|');
        const cName = document.getElementById('pos-cname').value || "Walk-in Customer";
        const disc = document.getElementById('pos-disc').value || 0;
        const total = parseInt(pPrice) - parseInt(disc);
        const date = new Date().toLocaleString();

        const win = window.open('', '', 'width=400,height=600');
        win.document.write(`
            <html><head><title>Invoice</title><style>body{font-family:monospace; padding:20px;}</style></head><body>
            <center>
                <h2>${userData.shopName}</h2>
                <p>${userData.address}<br>Tel: ${userData.phone1}</p>
                <hr>
                <h3>INVOICE</h3>
            </center>
            <p>Date: ${date}</p>
            <p>Customer: ${cName}</p>
            <table width="100%">
                <tr><td>${pName}</td><td align="right">${pPrice}</td></tr>
                <tr><td>Discount</td><td align="right">-${disc}</td></tr>
                <tr style="font-weight:bold; border-top:1px solid black;"><td>TOTAL</td><td align="right">Rs. ${total}</td></tr>
            </table>
            <center><p>Thank You!</p></center>
            </body></html>
        `);
        win.print();
        
        // Save to Orders (for record)
        db.collection('users').doc(user.uid).collection('orders').add({
            date, customer: cName, item: pName, total, type: 'POS'
        });
    }

    // --- 5. MARKETPLACE (Search) ---
    function renderMarketplace(target) {
        target.innerHTML = `
            <div class="card">
                <h3>Marketplace Search</h3>
                <input class="input-group" placeholder="Search furniture..." onkeyup="searchMarket(this.value)" style="padding:15px; width:100%;">
                <div id="search-results" style="margin-top:20px;"></div>
            </div>
        `;
    }
    
    async function searchMarket(term) {
        if(term.length < 3) return;
        const resDiv = document.getElementById('search-results');
        resDiv.innerHTML = 'Searching...';
        // Note: Client-side filtering is simpler for this structure without Algolia
        const snapshot = await db.collection('users').where('role', '==', 'seller').get();
        let html = '';
        snapshot.forEach(doc => {
            const d = doc.data();
            if(d.products) {
                d.products.forEach(p => {
                    if(p.name.toLowerCase().includes(term.toLowerCase())) {
                        html += `<div class="product-item"><img src="${p.images[0]}"> <b>${p.name}</b> (${d.shopName})</div>`;
                    }
                });
            }
        });
        resDiv.innerHTML = html || 'No matches found.';
    }

    // --- 6. WEBPAGE & EXTRAS ---
    function renderWebpage(target) {
        target.innerHTML = `
            <div class="card">
                <h3>My Webpage</h3>
                <p>Your online store link:</p>
                <a href="shop.html?id=${user.uid}" target="_blank" style="color:blue; word-break:break-all;">${window.location.origin}/shop.html?id=${user.uid}</a>
                <p style="font-size:0.8rem; color:#777; margin-top:10px;">Customers can chat with you here.</p>
            </div>
            <div class="card">
                <h3>Reviews</h3>
                <div id="review-list">No reviews yet.</div>
            </div>
        `;
        // Load reviews logic can be added here
    }

    function renderOrders(target) {
        target.innerHTML = `<div class="card"><h3>Orders</h3><p>Online orders feature coming soon.</p></div>`;
    }

    // --- UTILS ---
    async function uploadImage(input, type, index = 0) {
        const file = input.files[0];
        if(!file) return;
        
        // Compress using Canvas
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = async () => {
            const cvs = document.createElement('canvas');
            const ctx = cvs.getContext('2d');
            const scale = 600 / img.width; 
            cvs.width = 600; 
            cvs.height = img.height * scale;
            ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
            
            const dataUrl = cvs.toDataURL('image/jpeg', 0.7);
            const ref = storage.ref(`uploads/${user.uid}/${Date.now()}_${index}.jpg`);
            await ref.putString(dataUrl, 'data_url');
            const url = await ref.getDownloadURL();
            
            if(type === 'logo') {
                db.collection('users').doc(user.uid).update({ logo: url });
                userData.logo = url;
                renderProfile(document.getElementById('content-area'));
            } else if (type === 'verifyDoc') {
                userData.temp_verifyDoc = url;
            } else if (type === 'prod') {
                tempImages[index] = url;
            }
            alert("Image Uploaded!");
        };
    }
</script>
</body>
</html>
