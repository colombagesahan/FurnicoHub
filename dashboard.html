<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seller Dashboard | FurnicoHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary: #4E342E; --secondary: #3E2723; --gold: #D4AF37;
            --bg: #F5F5F5; --surface: #FFF; --red: #c62828; --green: #27ae60;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--secondary); padding-bottom: 70px; }
        * { box-sizing: border-box; outline: none; }

        /* HEADER */
        .header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 999; }
        .header h2 { margin: 0; font-size: 1.2rem; }
        
        /* TABS SCROLLER */
        .tabs { display: flex; overflow-x: auto; background: white; padding: 10px; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); scrollbar-width: none; }
        .tab { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; white-space: nowrap; font-size: 0.9rem; cursor: pointer; color: #555; display: flex; align-items: center; gap: 5px; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* CONTENT */
        #content { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMS */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #6D4C41; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        input:disabled, textarea:disabled { background: #eee; color: #777; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; display:flex; justify-content:center; align-items:center; gap:8px;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-gold { background: var(--gold); color: #3E2723; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* UTILS */
        .hidden { display: none; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; background: #eee; }
        .badge.verified { background: #e8f5e9; color: var(--green); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom:10px; }
        .img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="header">
    <h2>FurnicoHub <small style="font-size:0.7rem; opacity:0.8;">Seller</small></h2>
    <button class="btn" style="width:auto; padding:5px 10px; background:#6D4C41; color:white;" onclick="auth.signOut()">Logout</button>
</div>

<div class="tabs" id="tab-container"></div>
<div id="content"></div>

<!-- POS Invoice Print Hidden -->
<iframe id="printFrame" style="display:none;"></iframe>

<script>
    // CONFIG
    const firebaseConfig = { apiKey: "AIzaSyCbqz4vsik5tiuAUvIL_-FiquhrZcXX0N0", authDomain: "furnicohub.firebaseapp.com", projectId: "furnicohub", storageBucket: "furnicohub.firebasestorage.app", messagingSenderId: "395576125006", appId: "1:395576125006:web:a848f68053c69409ddc51f" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let user = null;
    let shopData = {};
    let activeTab = 'Profile';

    const TABS = [
        { id: 'SmartPOS', icon: 'fa-cash-register' },
        { id: 'Marketplace', icon: 'fa-store' },
        { id: 'Profile', icon: 'fa-user' },
        { id: 'Verify', icon: 'fa-certificate' },
        { id: 'Status', icon: 'fa-clock' },
        { id: 'Products', icon: 'fa-couch' },
        { id: 'Webpage', icon: 'fa-globe' },
        { id: 'Orders', icon: 'fa-box' },
        { id: 'Messages', icon: 'fa-comment' },
        { id: 'Reviews', icon: 'fa-star' }
    ];

    // AUTH
    auth.onAuthStateChanged(u => {
        if (!u) {
            // Simple Login Form Injection if not logged in
            document.body.innerHTML = `
                <div style="padding:40px; text-align:center; max-width:400px; margin:50px auto; background:white; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.1);">
                    <h2 style="color:#4E342E;">FurnicoHub Seller</h2>
                    <p>Log in with Google to manage your shop.</p>
                    <button class="btn btn-primary" onclick="login()">Login with Google</button>
                    <a href="index.html" style="display:block; margin-top:20px; font-size:0.9rem;">Back to Home</a>
                </div>
            `;
        } else {
            user = u;
            loadData();
        }
    });

    function login() {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }

    async function loadData() {
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists) {
            shopData = doc.data();
        } else {
            // Init new user
            shopData = { role: 'seller', verified: false, profileSaved: false, products: [] };
            await db.collection('users').doc(user.uid).set(shopData);
        }
        
        // Tab Logic: Force Profile if not saved
        if (!shopData.profileSaved) activeTab = 'Profile';
        else if (activeTab === 'Profile') activeTab = 'Marketplace'; // Default after profile
        
        renderTabs();
        renderContent();
    }

    function renderTabs() {
        const container = document.getElementById('tab-container');
        container.innerHTML = TABS.map(t => 
            `<div class="tab ${activeTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">
                <i class="fa-solid ${t.icon}"></i> ${t.id}
             </div>`
        ).join('');
    }

    function switchTab(id) {
        if (!shopData.profileSaved && id !== 'Profile') {
            alert("Please save your Profile first.");
            return;
        }
        activeTab = id;
        renderTabs();
        renderContent();
    }

    // CONTENT RENDERER
    function renderContent() {
        const c = document.getElementById('content');
        c.innerHTML = '';

        switch(activeTab) {
            case 'Profile': renderProfile(c); break;
            case 'Verify': renderVerify(c); break;
            case 'SmartPOS': renderPOS(c); break;
            case 'Marketplace': renderMarket(c); break;
            case 'Status': renderStatus(c); break;
            case 'Products': renderProducts(c); break;
            case 'Webpage': renderWebpage(c); break;
            case 'Orders': renderOrders(c); break;
            case 'Messages': c.innerHTML = '<div class="card"><h3>Messages</h3><p>Chat feature coming soon.</p></div>'; break;
            case 'Reviews': renderReviews(c); break;
        }
    }

    // --- 1. PROFILE ---
    function renderProfile(div) {
        const d = shopData;
        const disabled = d.verified ? 'disabled' : ''; // LOCK if verified
        const note = d.verified ? '<p style="color:red; font-size:0.8rem;">Profile Locked because you are Verified.</p>' : '';
        
        div.innerHTML = `
            <div class="card">
                <h3>Shop Profile</h3>
                ${note}
                <div class="form-group center" style="text-align:center;">
                    <img src="${d.logo || 'logo.png'}" id="prev-logo" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid var(--primary);">
                    ${!d.verified ? `<br><label class="btn btn-outline" style="width:auto; display:inline-block; margin-top:10px;">Upload Logo <input type="file" hidden onchange="uploadImg(this, 'logo')"></label>` : ''}
                </div>
                <div class="form-group"><label>Shop Name *</label><input id="p-name" value="${d.shopName||''}" ${disabled}></div>
                <div class="form-group"><label>Shop Address *</label><textarea id="p-addr" ${disabled}>${d.address||''}</textarea></div>
                <div class="form-group"><label>Owner Name *</label><input id="p-owner" value="${d.ownerName||''}" ${disabled}></div>
                <div class="form-group"><label>NIC *</label><input id="p-nic" value="${d.nic||''}" ${disabled}></div>
                <div class="form-group"><label>Phone 1 *</label><input id="p-ph1" type="tel" value="${d.phone1||''}" ${disabled}></div>
                <div class="form-group"><label>WhatsApp (+94...) *</label><input id="p-wa" type="tel" value="${d.whatsapp||'+94'}" ${disabled} readonly onfocus="this.removeAttribute('readonly')"></div>
                
                ${!d.verified ? `<button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>` : ''}
            </div>
        `;
    }

    async function saveProfile() {
        const data = {
            shopName: document.getElementById('p-name').value,
            address: document.getElementById('p-addr').value,
            ownerName: document.getElementById('p-owner').value,
            nic: document.getElementById('p-nic').value,
            phone1: document.getElementById('p-ph1').value,
            whatsapp: document.getElementById('p-wa').value,
            logo: shopData.temp_logo || shopData.logo || '',
            profileSaved: true
        };
        if(!data.shopName || !data.phone1 || !data.logo) return alert("Fill all required fields & Logo");
        
        await db.collection('users').doc(user.uid).update(data);
        shopData = {...shopData, ...data};
        alert("Profile Saved!");
        loadData();
    }

    // --- 2. VERIFY ---
    function renderVerify(div) {
        if(shopData.verified) {
            div.innerHTML = `<div class="card" style="text-align:center; color:green;"><i class="fa-solid fa-circle-check fa-3x"></i><h3>Verified Seller</h3><p>You have the trusted badge.</p></div>`;
            return;
        }
        div.innerHTML = `
            <div class="card">
                <h3>Get Verified (Rs. 5000)</h3>
                <p>Build trust. Locked profile. Badges on all products.</p>
                <div style="background:#FFF3E0; padding:15px; border-radius:8px; font-size:0.9rem;">
                    <b>1. Download Profile:</b> <button class="btn btn-outline" onclick="printProfile()">Download PDF</button><br><br>
                    <b>2. Certify:</b> Get Stamp from Grama Niladhari / JP.<br><br>
                    <b>3. Pay 5000 LKR:</b><br>Bank: Commercial Bank, Homagama<br>Acc: 8750053306 (Colombage SD)<br><br>
                    <b>4. Upload:</b> Certified Doc & Payment Slip below.
                </div>
                <hr>
                <div class="form-group">
                    <label>Certified Document</label>
                    <input type="file" onchange="uploadImg(this, 'doc')">
                    <span id="stat-doc" style="color:green; display:none;">Uploaded</span>
                </div>
                <div class="form-group">
                    <label>Payment Slip</label>
                    <input type="file" onchange="uploadImg(this, 'slip')">
                    <span id="stat-slip" style="color:green; display:none;">Uploaded</span>
                </div>
                <button class="btn btn-green" onclick="submitVerify()">Submit for Review</button>
                <p style="font-size:0.8rem; margin-top:10px;">Support: 0703150742 | colombagesahan@gmail.com</p>
            </div>
        `;
    }
    
    function printProfile() {
        const w = window.open('','','width=600,height=600');
        w.document.write(`<h2>${shopData.shopName}</h2><p>Owner: ${shopData.ownerName}<br>NIC: ${shopData.nic}<br>Address: ${shopData.address}</p><br><br><p>________<br>GN/JP Signature</p>`);
        w.print();
    }

    async function submitVerify() {
        if(!shopData.temp_doc || !shopData.temp_slip) return alert("Upload both images.");
        await db.collection('admin_requests').add({
            uid: user.uid, type: 'verify', shopName: shopData.shopName, 
            doc: shopData.temp_doc, slip: shopData.temp_slip, timestamp: new Date().toISOString()
        });
        alert("Submitted! Admin will review.");
    }

    // --- 3. PRODUCTS ---
    let tempProdImgs = [null, null, null];
    function renderProducts(div) {
        tempProdImgs = [null, null, null];
        div.innerHTML = `
            <div class="card">
                <h3>Add Product</h3>
                <div class="form-group"><label>Category</label>
                    <select id="prod-cat"><option>Living Room</option><option>Bedroom</option><option>Dining</option><option>Office</option><option>Outdoor</option></select>
                </div>
                <div class="form-group"><label>Sub Category</label><input id="prod-sub" placeholder="e.g. Sofa"></div>
                <div class="form-group"><label>Name</label><input id="prod-name"></div>
                <div class="form-group"><label>Price (LKR)</label><input type="number" id="prod-price"></div>
                <div class="form-group"><label>Description</label><textarea id="prod-desc"></textarea></div>
                <div class="form-group"><label>Promo Text</label><input id="prod-promo" placeholder="e.g. 10% Off"></div>
                
                <div class="form-group">
                    <label>Images (Max 3)</label>
                    <div style="display:flex; gap:10px;">
                        ${[0,1,2].map(i => `<div class="upload-box" style="padding:10px; width:80px;" onclick="document.getElementById('f${i}').click()">+<input type="file" id="f${i}" hidden onchange="uploadImg(this, 'prod', ${i})"><img id="prev${i}" style="width:100%; display:none;"></div>`).join('')}
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addProduct()">Save Product</button>
            </div>
            
            <h3>Inventory</h3>
            ${(shopData.products||[]).map((p, i) => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="${p.images[0]}" style="width:50px; height:50px; border-radius:5px;">
                        <div><b>${p.name}</b><br><small>Rs. ${p.price}</small></div>
                    </div>
                    <button class="btn btn-outline" style="width:auto; padding:5px;" onclick="delProduct(${i})"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('')}
        `;
    }

    async function addProduct() {
        const imgs = tempProdImgs.filter(x => x);
        if(imgs.length === 0) return alert("Add at least 1 image");
        
        const prod = {
            id: Date.now(),
            name: document.getElementById('prod-name').value,
            category: document.getElementById('prod-cat').value,
            subCategory: document.getElementById('prod-sub').value,
            price: document.getElementById('prod-price').value,
            desc: document.getElementById('prod-desc').value,
            promoText: document.getElementById('prod-promo').value,
            images: imgs
        };
        
        if(!prod.name || !prod.price) return alert("Name & Price required");

        const newProds = [...(shopData.products||[]), prod];
        await db.collection('users').doc(user.uid).update({products: newProds});
        shopData.products = newProds;
        renderProducts(document.getElementById('content'));
    }

    async function delProduct(idx) {
        if(!confirm("Delete?")) return;
        shopData.products.splice(idx, 1);
        await db.collection('users').doc(user.uid).update({products: shopData.products});
        renderProducts(document.getElementById('content'));
    }

    // --- 4. SMART POS ---
    function renderPOS(div) {
        div.innerHTML = `
            <div class="card">
                <h3>Smart POS</h3>
                <div class="form-group">
                    <label>Select Item</label>
                    <select id="pos-item" onchange="calcPos()">
                        <option value="0|Select">Select...</option>
                        ${(shopData.products||[]).map(p => `<option value="${p.price}|${p.name}">${p.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group"><label>Customer Name</label><input id="pos-cust"></div>
                <div class="form-group"><label>Discount (LKR)</label><input type="number" id="pos-disc" value="0" oninput="calcPos()"></div>
                <h2 id="pos-total" style="text-align:right; color:var(--primary);">Rs. 0</h2>
                <button class="btn btn-green" onclick="printInv()">Generate Invoice</button>
            </div>
        `;
    }
    
    function calcPos() {
        const price = document.getElementById('pos-item').value.split('|')[0];
        const disc = document.getElementById('pos-disc').value;
        document.getElementById('pos-total').innerText = "Rs. " + (price - disc);
    }

    function printInv() {
        const [price, name] = document.getElementById('pos-item').value.split('|');
        if(name === 'Select') return;
        const cust = document.getElementById('pos-cust').value;
        const total = document.getElementById('pos-total').innerText;
        
        const html = `
            <div style="font-family:monospace; text-align:center; padding:20px;">
                <h3>${shopData.shopName}</h3>
                <p>${shopData.address}<br>${shopData.phone1}</p>
                <hr>
                <p>Date: ${new Date().toLocaleDateString()}<br>Cust: ${cust}</p>
                <table style="width:100%"><tr><td>${name}</td><td align="right">${price}</td></tr></table>
                <hr><h3>Total: ${total}</h3><p>Thank You!</p>
            </div>
        `;
        const iframe = document.getElementById('printFrame');
        iframe.contentDocument.body.innerHTML = html;
        iframe.contentWindow.print();
    }

    // --- 5. WEBPAGE & MARKETPLACE VIEW ---
    function renderWebpage(div) {
        const url = `${window.location.origin}/shop.html?id=${user.uid}`;
        div.innerHTML = `
            <div class="card" style="text-align:center;">
                <h3>My Webpage</h3>
                <p>Share this link with customers:</p>
                <input value="${url}" readonly style="text-align:center; background:#eee; margin-bottom:10px;">
                <a href="${url}" target="_blank" class="btn btn-primary">Open Page</a>
            </div>
        `;
    }
    
    function renderMarket(div) {
        div.innerHTML = `<div class="card"><h3>Marketplace View</h3><input placeholder="Search items..." onkeyup="searchM(this.value)"><div id="m-res" style="margin-top:10px;"></div></div>`;
        searchM('');
    }

    async function searchM(q) {
        // Simple client side search of *all* products (simplified for PWA)
        // In real app, use Firestore queries. Here we just show user their products + dummy message
        document.getElementById('m-res').innerHTML = (shopData.products||[]).filter(p => p.name.toLowerCase().includes(q.toLowerCase())).map(p => 
            `<div style="padding:10px; border-bottom:1px solid #eee;">${p.name} - Rs. ${p.price}</div>`
        ).join('');
    }

    // --- 6. ORDERS & REVIEWS ---
    function renderOrders(div) {
        // Listen to WhatsApp/Firestore Orders
        div.innerHTML = `<div class="card"><h3>Incoming Orders</h3><div id="order-list">Loading...</div></div>`;
        db.collection('users').doc(user.uid).collection('orders').orderBy('time', 'desc').onSnapshot(snap => {
            const list = document.getElementById('order-list');
            if(snap.empty) { list.innerHTML = "No orders yet."; return; }
            list.innerHTML = snap.docs.map(d => {
                const o = d.data();
                return `<div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:10px; border-left:4px solid var(--primary);">
                    <b>${o.custName}</b> (${o.custPhone})<br>
                    ${o.items.map(i => `${i.name}`).join(', ')}<br>
                    <b>Total: Rs. ${o.total}</b>
                </div>`;
            }).join('');
        });
    }

    function renderReviews(div) {
        div.innerHTML = `<div class="card"><h3>Reviews</h3><div id="rev-list"></div></div>`;
        db.collection('users').doc(user.uid).collection('reviews').onSnapshot(snap => {
            document.getElementById('rev-list').innerHTML = snap.docs.map(d => {
                const r = d.data();
                return `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${r.name}</b>: ${r.text} (${r.stars}â˜…)</div>`;
            }).join('');
        });
    }

    function renderStatus(div) {
        div.innerHTML = `
            <div class="card">
                <h3>Open/Close</h3>
                <label>Status</label>
                <select id="s-stat" onchange="saveStatus()"><option ${shopData.isOpen?'selected':''} value="open">Open</option><option ${!shopData.isOpen?'selected':''} value="closed">Closed</option></select>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div><label>Open Time</label><input type="time" id="t-open" value="${shopData.openTime||'09:00'}" onchange="saveStatus()"></div>
                    <div><label>Close Time</label><input type="time" id="t-close" value="${shopData.closeTime||'20:00'}" onchange="saveStatus()"></div>
                </div>
            </div>
        `;
    }

    async function saveStatus() {
        await db.collection('users').doc(user.uid).update({
            isOpen: document.getElementById('s-stat').value === 'open',
            openTime: document.getElementById('t-open').value,
            closeTime: document.getElementById('t-close').value
        });
    }

    // --- UTILS: COMPRESSION ---
    function uploadImg(input, type, idx) {
        const file = input.files[0];
        if(!file) return;
        
        // Compress
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const scale = 600/img.width;
                cvs.width = 600; cvs.height = img.height * scale;
                cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                
                const task = storage.ref(`img/${user.uid}/${Date.now()}.jpg`).putString(cvs.toDataURL('image/jpeg', 0.7), 'data_url');
                task.then(snap => snap.ref.getDownloadURL().then(url => {
                    if(type === 'logo') { shopData.temp_logo = url; document.getElementById('prev-logo').src = url; }
                    else if(type === 'doc') { shopData.temp_doc = url; document.getElementById('stat-doc').style.display='inline'; }
                    else if(type === 'slip') { shopData.temp_slip = url; document.getElementById('stat-slip').style.display='inline'; }
                    else if(type === 'prod') { tempProdImgs[idx] = url; document.getElementById('prev'+idx).src = url; document.getElementById('prev'+idx).style.display='block'; }
                }));
            }
        }
    }
</script>
</body>
</html>
