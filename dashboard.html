<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seller Dashboard | FurnicoHub</title>
    <!-- Theme Color -->
    <meta name="theme-color" content="#4E342E">
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary: #4E342E; --secondary: #3E2723; --gold: #D4AF37;
            --bg: #F5F5F5; --surface: #FFF; --red: #c62828; --green: #27ae60;
            --font: 'Poppins', sans-serif;
        }
        body { margin: 0; font-family: var(--font); background: var(--bg); color: var(--secondary); padding-bottom: 70px; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        /* HEADER */
        .header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 999; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h2 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        
        /* TABS SCROLLER */
        .tabs { display: flex; overflow-x: auto; background: white; padding: 12px 10px; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); scrollbar-width: none; }
        .tab { padding: 8px 16px; border-radius: 20px; border: 1px solid #EFEBE9; white-space: nowrap; font-size: 0.85rem; cursor: pointer; color: #6D4C41; display: flex; align-items: center; gap: 6px; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(78, 52, 46, 0.3); }

        /* CONTENT */
        #content { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; animation: fade 0.3s; border: 1px solid #f0f0f0; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMS */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: #6D4C41; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #EFEBE9; border-radius: 10px; font-size: 0.95rem; font-family: var(--font); transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); background: #fff; }
        input:disabled, textarea:disabled { background: #eee; color: #777; border-color: #ddd; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; display:flex; justify-content:center; align-items:center; gap:8px; font-size: 0.9rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(78, 52, 46, 0.2); }
        .btn-green { background: var(--green); color: white; }
        .btn-gold { background: var(--gold); color: #3E2723; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* LOGIN SCREEN */
        .login-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 90vh; padding: 20px; text-align: center;
        }

        /* UTILS */
        .hidden { display: none; }
        .upload-box { border: 2px dashed #D7CCC8; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom:10px; background: #FAFAFA; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; background: #eee; }
        .badge.verified { background: #e8f5e9; color: var(--green); }
    </style>
</head>
<body>

<!-- This div wraps the entire Dashboard UI -->
<div id="dashboard-ui" style="display: none;">
    <div class="header">
        <h2><img src="icon.png" style="height:25px;"> Seller Portal</h2>
        <button class="btn" style="width:auto; padding:6px 14px; background:rgba(255,255,255,0.15); color:white; margin:0; font-size:0.8rem;" onclick="logout()">
            <i class="fa-solid fa-right-from-bracket"></i>
        </button>
    </div>

    <div class="tabs" id="tab-container"></div>
    <div id="content"></div>
</div>

<!-- This div is for Login UI -->
<div id="login-ui" class="login-container">
    <div class="card" style="width: 100%; max-width: 400px; padding: 40px 20px;">
        <img src="logo.png" style="width: 80px; margin-bottom: 20px;">
        <h2 style="color:#4E342E; margin-bottom: 10px;">Welcome Seller</h2>
        <p style="color:#888; margin-bottom: 30px;">Manage your shop, products, and orders.</p>
        <button class="btn btn-primary" onclick="login()">
            <i class="fa-brands fa-google"></i> Login with Google
        </button>
        <a href="index.html" class="btn btn-outline" style="margin-top: 15px;">Back to Marketplace</a>
    </div>
</div>

<!-- Hidden iframe for POS Printing -->
<iframe id="printFrame" style="display:none;"></iframe>

<script>
    // 1. CONFIG
    const firebaseConfig = { apiKey: "AIzaSyCbqz4vsik5tiuAUvIL_-FiquhrZcXX0N0", authDomain: "furnicohub.firebaseapp.com", projectId: "furnicohub", storageBucket: "furnicohub.firebasestorage.app", messagingSenderId: "395576125006", appId: "1:395576125006:web:a848f68053c69409ddc51f" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let user = null;
    let shopData = {};
    let activeTab = 'Profile';

    const TABS = [
        { id: 'SmartPOS', icon: 'fa-cash-register' },
        { id: 'Marketplace', icon: 'fa-store' },
        { id: 'Profile', icon: 'fa-user-pen' },
        { id: 'Verify', icon: 'fa-certificate' },
        { id: 'Status', icon: 'fa-clock' },
        { id: 'Products', icon: 'fa-couch' },
        { id: 'Webpage', icon: 'fa-globe' },
        { id: 'Orders', icon: 'fa-box-open' },
        { id: 'Messages', icon: 'fa-comments' },
        { id: 'Reviews', icon: 'fa-star' }
    ];

    // 2. AUTH STATE LISTENER
    auth.onAuthStateChanged(u => {
        if (u) {
            user = u;
            // Switch UI to Dashboard
            document.getElementById('login-ui').style.display = 'none';
            document.getElementById('dashboard-ui').style.display = 'block';
            loadData();
        } else {
            // Switch UI to Login
            document.getElementById('dashboard-ui').style.display = 'none';
            document.getElementById('login-ui').style.display = 'flex';
        }
    });

    // Use Redirect to avoid COOP/COEP popup blocking on mobile
    function login() {
        auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
    }

    function logout() {
        auth.signOut();
    }

    // 3. LOAD DATA
    async function loadData() {
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists) {
            shopData = doc.data();
        } else {
            // Initialize new seller
            shopData = { role: 'seller', verified: false, profileSaved: false, products: [] };
            await db.collection('users').doc(user.uid).set(shopData);
        }
        
        // Force Profile Completion
        if (!shopData.profileSaved) activeTab = 'Profile';
        else if (activeTab === 'Profile') activeTab = 'Marketplace';
        
        renderTabs();
        renderContent();
    }

    function renderTabs() {
        const container = document.getElementById('tab-container');
        if(!container) return; // Safety check

        container.innerHTML = TABS.map(t => 
            `<div class="tab ${activeTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">
                <i class="fa-solid ${t.icon}"></i> ${t.id}
             </div>`
        ).join('');
    }

    function switchTab(id) {
        if (!shopData.profileSaved && id !== 'Profile') {
            alert("Please save your Profile first.");
            return;
        }
        activeTab = id;
        renderTabs();
        renderContent();
    }

    // 4. RENDERERS
    function renderContent() {
        const c = document.getElementById('content');
        c.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>'; // Loading state

        setTimeout(() => {
            c.innerHTML = ''; // Clear loading
            switch(activeTab) {
                case 'Profile': renderProfile(c); break;
                case 'Verify': renderVerify(c); break;
                case 'SmartPOS': renderPOS(c); break;
                case 'Marketplace': renderMarket(c); break;
                case 'Status': renderStatus(c); break;
                case 'Products': renderProducts(c); break;
                case 'Webpage': renderWebpage(c); break;
                case 'Orders': renderOrders(c); break;
                case 'Messages': c.innerHTML = '<div class="card"><h3>Messages</h3><p>Customer chat coming soon.</p></div>'; break;
                case 'Reviews': renderReviews(c); break;
            }
        }, 50);
    }

    // --- TAB: PROFILE ---
    function renderProfile(div) {
        const d = shopData;
        const disabled = d.verified ? 'disabled' : '';
        const note = d.verified ? '<div style="background:#E8F5E9; color:#2E7D32; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.85rem;"><i class="fa-solid fa-lock"></i> Profile Locked (Verified)</div>' : '';
        
        div.innerHTML = `
            <div class="card">
                <h3>Shop Profile</h3>
                ${note}
                <div class="form-group" style="text-align:center;">
                    <div style="position:relative; display:inline-block;">
                        <img src="${d.logo || 'logo.png'}" id="prev-logo" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--primary);">
                        ${!d.verified ? `<label style="position:absolute; bottom:0; right:0; background:var(--primary); color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;"><i class="fa-solid fa-camera"></i><input type="file" hidden onchange="uploadImg(this, 'logo')"></label>` : ''}
                    </div>
                </div>
                <div class="form-group"><label>Shop Name *</label><input id="p-name" value="${d.shopName||''}" ${disabled}></div>
                <div class="form-group"><label>Shop Address *</label><textarea id="p-addr" ${disabled}>${d.address||''}</textarea></div>
                <div class="form-group"><label>Owner Name *</label><input id="p-owner" value="${d.ownerName||''}" ${disabled}></div>
                <div class="form-group"><label>NIC Number *</label><input id="p-nic" value="${d.nic||''}" ${disabled}></div>
                <div class="form-group"><label>Phone 1 *</label><input id="p-ph1" type="tel" value="${d.phone1||''}" ${disabled}></div>
                <div class="form-group"><label>WhatsApp (+94...) *</label><input id="p-wa" type="tel" value="${d.whatsapp||'+94'}" ${disabled}></div>
                
                ${!d.verified ? `<button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>` : ''}
            </div>
        `;
    }

    async function saveProfile() {
        const wa = document.getElementById('p-wa').value;
        if (!wa.startsWith('+94')) return alert("WhatsApp must start with +94");

        const data = {
            shopName: document.getElementById('p-name').value,
            address: document.getElementById('p-addr').value,
            ownerName: document.getElementById('p-owner').value,
            nic: document.getElementById('p-nic').value,
            phone1: document.getElementById('p-ph1').value,
            whatsapp: wa,
            logo: shopData.temp_logo || shopData.logo || '',
            profileSaved: true
        };

        if(!data.shopName || !data.logo) return alert("Shop Name and Logo are required.");
        
        try {
            await db.collection('users').doc(user.uid).update(data);
            shopData = {...shopData, ...data};
            alert("Profile Saved!");
            switchTab('Marketplace'); // Redirect to next logical tab
        } catch(e) { alert("Error saving profile: " + e.message); }
    }

    // --- TAB: VERIFY ---
    function renderVerify(div) {
        if(shopData.verified) {
            div.innerHTML = `<div class="card" style="text-align:center; color:green; padding:40px;"><i class="fa-solid fa-circle-check fa-4x" style="margin-bottom:15px;"></i><h3>Verified Seller</h3><p>Your shop has the trusted badge.</p></div>`;
            return;
        }
        div.innerHTML = `
            <div class="card">
                <h3>Get Verified <span style="font-size:0.8rem; background:#FFF3E0; color:#E65100; padding:2px 8px; border-radius:10px;">Rs. 5000</span></h3>
                <p style="font-size:0.9rem; color:#666;">Verification locks your profile and adds a trust badge to all your products.</p>
                
                <div style="background:#FAFAFA; padding:15px; border-radius:10px; font-size:0.9rem; margin:15px 0; border:1px solid #eee;">
                    <b>1. Download Profile:</b> <button class="btn btn-outline" style="padding:5px 10px; width:auto; display:inline-block; font-size:0.8rem;" onclick="printProfile()">Download PDF</button><br><br>
                    <b>2. Certify:</b> Get it stamped by Grama Niladhari or JP.<br><br>
                    <b>3. Pay 5000 LKR:</b><br>Bank: Commercial Bank, Homagama<br>Acc: 8750053306 (Colombage SD)<br><br>
                    <b>4. Upload Proofs:</b> Upload the Certified Doc & Payment Slip.
                </div>
                
                <div class="form-group">
                    <label>Certified Document Photo</label>
                    <div class="upload-box" onclick="document.getElementById('f-doc').click()">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Upload Doc
                        <input type="file" id="f-doc" hidden onchange="uploadImg(this, 'doc')">
                    </div>
                    <span id="stat-doc" style="color:green; display:none; font-weight:bold;">✅ Uploaded</span>
                </div>

                <div class="form-group">
                    <label>Payment Slip Photo</label>
                    <div class="upload-box" onclick="document.getElementById('f-slip').click()">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Upload Slip
                        <input type="file" id="f-slip" hidden onchange="uploadImg(this, 'slip')">
                    </div>
                    <span id="stat-slip" style="color:green; display:none; font-weight:bold;">✅ Uploaded</span>
                </div>

                <button class="btn btn-green" onclick="submitVerify()">Submit for Review</button>
            </div>
        `;
    }
    
    function printProfile() {
        const w = window.open('','','width=600,height=600');
        w.document.write(`
            <h1 style="text-align:center">FurnicoHub Seller Profile</h1>
            <hr>
            <h3>${shopData.shopName}</h3>
            <p><b>Owner:</b> ${shopData.ownerName}</p>
            <p><b>NIC:</b> ${shopData.nic}</p>
            <p><b>Address:</b> ${shopData.address}</p>
            <p><b>Phone:</b> ${shopData.phone1}</p>
            <br><br><br><br>
            <p>__________________________</p>
            <p>Grama Niladhari / JP Signature & Stamp</p>
        `);
        w.print();
    }

    async function submitVerify() {
        if(!shopData.temp_doc || !shopData.temp_slip) return alert("Please upload both documents.");
        try {
            await db.collection('admin_requests').add({
                uid: user.uid, type: 'verify', shopName: shopData.shopName, 
                doc: shopData.temp_doc, slip: shopData.temp_slip, timestamp: new Date().toISOString()
            });
            alert("Submitted Successfully! Admin will review shortly.");
        } catch(e) { alert("Error: " + e.message); }
    }

    // --- TAB: PRODUCTS ---
    let tempProdImgs = [null, null, null];
    function renderProducts(div) {
        tempProdImgs = [null, null, null]; // Reset
        div.innerHTML = `
            <div class="card">
                <h3>Add New Furniture</h3>
                <div class="form-group"><label>Category</label>
                    <select id="prod-cat">
                        <option>Living Room</option>
                        <option>Bedroom</option>
                        <option>Dining</option>
                        <option>Office</option>
                        <option>Outdoor</option>
                    </select>
                </div>
                <div class="form-group"><label>Sub Category</label><input id="prod-sub" placeholder="e.g. Sofa, Bed"></div>
                
                <div class="form-group">
                    <label>Product Images (Max 3)</label>
                    <div style="display:flex; gap:10px; overflow-x:auto;">
                        ${[0,1,2].map(i => `
                            <div class="upload-box" style="width:80px; height:80px; padding:0; display:flex; align-items:center; justify-content:center;" onclick="document.getElementById('f${i}').click()">
                                <i class="fa-solid fa-plus"></i>
                                <input type="file" id="f${i}" hidden onchange="uploadImg(this, 'prod', ${i})">
                                <img id="prev${i}" style="width:100%; height:100%; object-fit:cover; border-radius:10px; display:none;">
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="form-group"><label>Product Name</label><input id="prod-name"></div>
                <div class="form-group"><label>Description</label><textarea id="prod-desc" rows="3"></textarea></div>
                <div class="form-group"><label>Promo Text (Short)</label><input id="prod-promo" placeholder="e.g. 10% Off"></div>
                <div class="form-group"><label>Price (LKR)</label><input type="number" id="prod-price"></div>
                
                <button class="btn btn-primary" onclick="addProduct()">Save Product</button>
            </div>
            
            <h3>My Inventory</h3>
            ${(shopData.products||[]).length === 0 ? '<p style="text-align:center; color:#999;">No products yet.</p>' : ''}
            ${(shopData.products||[]).map((p, i) => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
                    <div style="display:flex; gap:15px; align-items:center;">
                        <img src="${p.images[0]}" style="width:60px; height:60px; border-radius:8px; object-fit:cover;">
                        <div>
                            <div style="font-weight:bold;">${p.name}</div>
                            <div style="font-size:0.8rem; color:#777;">Rs. ${p.price}</div>
                        </div>
                    </div>
                    <button class="btn btn-outline" style="width:auto; padding:8px 12px; color:var(--red); border-color:var(--red);" onclick="delProduct(${i})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('')}
        `;
    }

    async function addProduct() {
        const imgs = tempProdImgs.filter(x => x);
        if(imgs.length === 0) return alert("Please upload at least 1 image.");
        
        const prod = {
            id: Date.now(),
            name: document.getElementById('prod-name').value,
            category: document.getElementById('prod-cat').value,
            subCategory: document.getElementById('prod-sub').value,
            price: document.getElementById('prod-price').value,
            desc: document.getElementById('prod-desc').value,
            promoText: document.getElementById('prod-promo').value,
            images: imgs
        };
        
        if(!prod.name || !prod.price) return alert("Name & Price required.");

        const newProds = [...(shopData.products||[]), prod];
        await db.collection('users').doc(user.uid).update({products: newProds});
        shopData.products = newProds;
        renderProducts(document.getElementById('content'));
    }

    async function delProduct(idx) {
        if(!confirm("Are you sure you want to delete this product?")) return;
        shopData.products.splice(idx, 1);
        await db.collection('users').doc(user.uid).update({products: shopData.products});
        renderProducts(document.getElementById('content'));
    }

    // --- TAB: SMART POS ---
    function renderPOS(div) {
        div.innerHTML = `
            <div class="card">
                <h3><i class="fa-solid fa-calculator"></i> Smart POS</h3>
                <div class="form-group">
                    <label>Select Product</label>
                    <select id="pos-item" onchange="calcPos()">
                        <option value="0|Select">Select Item...</option>
                        ${(shopData.products||[]).map(p => `<option value="${p.price}|${p.name}">${p.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group"><label>Customer Name</label><input id="pos-cust"></div>
                <div class="form-group"><label>Discount (LKR)</label><input type="number" id="pos-disc" value="0" oninput="calcPos()"></div>
                
                <div style="background:#f9f9f9; padding:15px; border-radius:10px; text-align:right; margin-bottom:15px;">
                    <span style="font-size:0.9rem; color:#777;">Total Amount</span><br>
                    <span id="pos-total" style="font-size:1.5rem; font-weight:bold; color:var(--primary);">Rs. 0</span>
                </div>
                
                <button class="btn btn-green" onclick="printInv()">Generate Invoice</button>
            </div>
        `;
    }
    
    function calcPos() {
        const val = document.getElementById('pos-item').value;
        if(!val) return;
        const price = val.split('|')[0];
        const disc = document.getElementById('pos-disc').value || 0;
        document.getElementById('pos-total').innerText = "Rs. " + (price - disc);
    }

    function printInv() {
        const [price, name] = document.getElementById('pos-item').value.split('|');
        if(name === 'Select') return alert("Select a product first.");
        const cust = document.getElementById('pos-cust').value || 'Walk-in Customer';
        const total = document.getElementById('pos-total').innerText;
        
        const html = `
            <div style="font-family:monospace; text-align:center; padding:20px;">
                <h3 style="margin:0;">${shopData.shopName}</h3>
                <p style="margin:5px 0;">${shopData.address}<br>${shopData.phone1}</p>
                <hr style="border-top:1px dashed #000;">
                <p style="text-align:left;">Date: ${new Date().toLocaleDateString()}<br>Cust: ${cust}</p>
                <table style="width:100%"><tr><td>${name}</td><td align="right">${price}</td></tr></table>
                <hr style="border-top:1px dashed #000;">
                <h3 style="text-align:right;">Total: ${total}</h3>
                <p>Thank You!</p>
            </div>
        `;
        const iframe = document.getElementById('printFrame');
        iframe.contentDocument.body.innerHTML = html;
        iframe.contentWindow.print();
    }

    // --- TAB: MARKETPLACE ---
    function renderMarket(div) {
        div.innerHTML = `
            <div class="card">
                <h3>Marketplace</h3>
                <input placeholder="Search products..." onkeyup="searchM(this.value)">
                <div id="m-res" style="margin-top:15px;"></div>
            </div>`;
        searchM('');
    }

    async function searchM(q) {
        // Just searching own products for this PWA demo to show structure
        // In real app this would query the global products collection
        const term = q.toLowerCase();
        const results = (shopData.products||[]).filter(p => p.name.toLowerCase().includes(term));
        
        const div = document.getElementById('m-res');
        if(results.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:#999;">No products found.</p>';
        } else {
            div.innerHTML = results.map(p => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; gap:10px; align-items:center;">
                    <img src="${p.images[0]}" style="width:40px; height:40px; border-radius:5px; object-fit:cover;">
                    <div>${p.name}<br><small>Rs. ${p.price}</small></div>
                </div>
            `).join('');
        }
    }

    // --- TAB: WEBPAGE ---
    function renderWebpage(div) {
        const url = `${window.location.origin}/shop.html?id=${user.uid}`;
        div.innerHTML = `
            <div class="card" style="text-align:center;">
                <img src="${shopData.logo || 'icon.png'}" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px;">
                <h3>${shopData.shopName}</h3>
                <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">Your public showroom link:</p>
                <input value="${url}" readonly style="text-align:center; background:#f9f9f9; color:#555; margin-bottom:15px;">
                <a href="${url}" target="_blank" class="btn btn-primary">Visit Webpage</a>
                <button class="btn btn-outline" onclick="navigator.clipboard.writeText('${url}'); alert('Copied!');">Copy Link</button>
            </div>
        `;
    }

    // --- TAB: STATUS ---
    function renderStatus(div) {
        div.innerHTML = `
            <div class="card">
                <h3>Shop Status</h3>
                <div class="form-group">
                    <label>Current Status</label>
                    <select id="s-stat" onchange="saveStatus()">
                        <option ${shopData.isOpen?'selected':''} value="open">Open</option>
                        <option ${!shopData.isOpen?'selected':''} value="closed">Closed</option>
                    </select>
                </div>
                <div style="display:flex; gap:15px;">
                    <div style="flex:1;"><label>Open Time</label><input type="time" id="t-open" value="${shopData.openTime||'09:00'}" onchange="saveStatus()"></div>
                    <div style="flex:1;"><label>Close Time</label><input type="time" id="t-close" value="${shopData.closeTime||'20:00'}" onchange="saveStatus()"></div>
                </div>
            </div>
        `;
    }

    async function saveStatus() {
        await db.collection('users').doc(user.uid).update({
            isOpen: document.getElementById('s-stat').value === 'open',
            openTime: document.getElementById('t-open').value,
            closeTime: document.getElementById('t-close').value
        });
    }

    // --- TAB: ORDERS ---
    function renderOrders(div) {
        div.innerHTML = `<div class="card"><h3>Incoming Orders</h3><div id="order-list">Loading...</div></div>`;
        db.collection('users').doc(user.uid).collection('orders').orderBy('time', 'desc').limit(20).onSnapshot(snap => {
            const list = document.getElementById('order-list');
            if(snap.empty) { list.innerHTML = "<p style='color:#999; text-align:center;'>No orders yet.</p>"; return; }
            list.innerHTML = snap.docs.map(d => {
                const o = d.data();
                return `
                <div style="background:#FAFAFA; padding:15px; border-radius:10px; margin-bottom:15px; border-left:4px solid var(--primary); box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <b style="color:var(--primary);">${o.custName}</b>
                        <small>${new Date(o.time).toLocaleDateString()}</small>
                    </div>
                    <div style="font-size:0.9rem; margin-bottom:5px;">${o.items.map(i => `${i.name}`).join(', ')}</div>
                    <div style="font-weight:bold; text-align:right;">Total: Rs. ${o.total}</div>
                </div>`;
            }).join('');
        });
    }

    // --- TAB: REVIEWS ---
    function renderReviews(div) {
        div.innerHTML = `<div class="card"><h3>Reviews</h3><div id="rev-list">Loading...</div></div>`;
        db.collection('users').doc(user.uid).collection('reviews').limit(20).onSnapshot(snap => {
            const list = document.getElementById('rev-list');
            if(snap.empty) { list.innerHTML = "<p style='color:#999; text-align:center;'>No reviews yet.</p>"; return; }
            list.innerHTML = snap.docs.map(d => {
                const r = d.data();
                return `<div style="padding:15px; border-bottom:1px solid #eee;">
                    <b>${r.name}</b> <span style="color:#FFC107;">${'★'.repeat(r.stars)}</span>
                    <p style="margin:5px 0 0; color:#555; font-size:0.9rem;">"${r.text}"</p>
                </div>`;
            }).join('');
        });
    }

    // 5. UTILS: IMAGE COMPRESSION & UPLOAD
    function uploadImg(input, type, idx) {
        const file = input.files[0];
        if(!file) return;
        
        // Show loading placeholder
        if(idx !== undefined) {
             document.getElementById('prev'+idx).style.display = 'block';
             document.getElementById('prev'+idx).src = 'https://i.gifer.com/ZZ5H.gif'; // loading gif
        }

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                // Resize logic: Max width 600px
                const scale = 600/img.width;
                cvs.width = 600; cvs.height = img.height * scale;
                const ctx = cvs.getContext('2d');
                ctx.drawImage(img,0,0,cvs.width,cvs.height);
                
                // Upload to Firebase Storage
                const task = storage.ref(`img/${user.uid}/${Date.now()}.jpg`).putString(cvs.toDataURL('image/jpeg', 0.7), 'data_url');
                
                task.then(snap => snap.ref.getDownloadURL().then(url => {
                    if(type === 'logo') { 
                        shopData.temp_logo = url; 
                        document.getElementById('prev-logo').src = url; 
                    }
                    else if(type === 'doc') { 
                        shopData.temp_doc = url; 
                        document.getElementById('stat-doc').style.display='block'; 
                    }
                    else if(type === 'slip') { 
                        shopData.temp_slip = url; 
                        document.getElementById('stat-slip').style.display='block'; 
                    }
                    else if(type === 'prod') { 
                        tempProdImgs[idx] = url; 
                        document.getElementById('prev'+idx).src = url; 
                    }
                }));
            }
        }
    }
</script>
</body>
</html>
