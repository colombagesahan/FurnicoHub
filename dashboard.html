<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FurnicoHub | Seller Portal</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#E65100">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="icon.png">

    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            /* COLOR PALETTE - ORANGE */
            --primary: #FF6D00;        
            --primary-light: #FF9E80;
            --accent: #E65100;         
            --bg-body: #FFF3E0;
            --surface: #FFFFFF;
            --text: #3E2723;
            --green: #2E7D32;
            --red: #C62828;
            --gold: #FFC107;
            
            --shadow: 0 4px 12px rgba(62, 39, 35, 0.1);
            --radius: 12px;
            --font: 'Poppins', sans-serif;
            --sidebar-w: 260px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font); background: var(--bg-body); color: var(--text); padding-bottom: 80px; font-size: 14px; }
        a { text-decoration: none; color: inherit; }
        
        /* UTILS */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .space-between { justify-content: space-between; }
        .center { text-align: center; }
        .bold { font-weight: 700; }
        .w-100 { width: 100%; }
        .mb-1 { margin-bottom: 10px; }
        .mt-1 { margin-top: 10px; }
        .text-primary { color: var(--primary); }

        /* COMPONENTS */
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 12px;
            background: var(--primary); color: white; font-weight: 600;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.9rem; transition: 0.2s; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(230, 81, 0, 0.2); text-decoration: none;
        }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; margin: 0; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }

        .card {
            background: var(--surface); padding: 15px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 15px;
            border: 1px solid #FFE0B2; animation: slideUp 0.4s ease-out;
        }

        .input-group { margin-bottom: 15px; width: 100%; }
        .input-group label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: #5D4037; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px; border: 2px solid #FFE0B2; border-radius: 12px;
            font-family: var(--font); font-size: 0.95rem; background: #FFF; transition: 0.3s;
        }
        .input-group input:focus { border-color: var(--primary); }

        /* FILE UPLOAD */
        .upload-box {
            border: 2px dashed #FFCC80; border-radius: 12px; padding: 15px;
            text-align: center; cursor: pointer; background: #FFF8E1; position: relative;
        }
        .upload-box img { width: 100%; height: 80px; object-fit: cover; border-radius: 8px; display: none; margin-top: 5px; }

        /* LOGIN SCREEN */
        #login-ui {
            height: 100vh; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 20px;
            background: radial-gradient(circle at center, #FFF3E0 0%, #FFCC80 100%);
        }

        /* NAVIGATION */
        .mobile-header {
            background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .tabs-container {
            width: 100%; overflow-x: auto; background: white; 
            padding: 10px; display: flex; gap: 8px;
            scrollbar-width: none; border-bottom: 1px solid #FFE0B2;
        }
        .tab-btn {
            padding: 8px 18px; background: #FFF8E1; border: 1px solid #FFE0B2;
            border-radius: 20px; white-space: nowrap; cursor: pointer;
            color: #5D4037; font-size: 0.85rem; display: flex; align-items: center; gap: 6px;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(255, 109, 0, 0.3); }

        @media (min-width: 900px) {
            .mobile-header { display: none; }
            #dashboard-ui { display: flex; }
            .tabs-container {
                flex-direction: column; width: var(--sidebar-w); height: 100vh;
                position: fixed; left: 0; top: 0; background: white; border-right: 1px solid #eee;
                padding: 25px; gap: 8px; border-bottom: none;
            }
            #content-area { margin-left: var(--sidebar-w); padding: 40px; width: calc(100% - var(--sidebar-w)); max-width: 1200px; }
        }

        /* 250px RESPONSIVENESS */
        @media (max-width: 350px) {
            .card { padding: 12px; }
            .stat-grid { grid-template-columns: 1fr !important; }
            .day-row { flex-direction: column; align-items: flex-start; gap: 5px; }
            .day-row input, .day-row select { width: 100%; }
            h2, h3 { font-size: 1.1rem; }
        }

        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 16px; text-align: center; border-bottom: 4px solid transparent; box-shadow: var(--shadow); }
        .toggle-switch { display: flex; background: #eee; border-radius: 50px; padding: 4px; width: fit-content; margin: 0 auto 15px; }
        .toggle-opt { padding: 6px 16px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .toggle-opt.active { background: var(--primary); color: white; }
        .day-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }

        @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-ui">
        <div class="card" style="width: 100%; max-width: 350px; text-align: center; padding: 40px 25px;">
            <img src="logo.png" onerror="this.src='https://via.placeholder.com/100'" style="width: 90px; height: 90px; object-fit: cover; border-radius: 50%; border: 4px solid var(--primary); margin-bottom: 20px;">
            <h2 style="color:var(--primary); margin-bottom: 5px;">Seller Portal</h2>
            <p style="color:#666; margin-bottom: 30px;">Manage your furniture shop.</p>
            <button class="btn" onclick="login()"><i class="fa-brands fa-google"></i> Login with Google</button>
            <a href="index.html" class="btn btn-outline" style="margin-top: 10px;">Back to Marketplace</a>
        </div>
    </div>

    <!-- 2. DASHBOARD UI -->
    <div id="dashboard-ui" class="hidden">
        <div class="mobile-header">
            <div class="bold" style="font-size:1.1rem; display:flex; align-items:center; gap:8px; color:var(--primary);">
                FurnicoHub
            </div>
            <button class="btn" style="width:auto; padding:6px 14px; margin:0; background:#FFF3E0; color:var(--primary);" onclick="logout()">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>

        <div class="tabs-container" id="tabs-nav"></div>

        <div id="content-area" style="padding: 20px;">
            <div style="text-align:center; padding:50px; color:#aaa;">
                <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCbqz4vsik5tiuAUvIL_-FiquhrZcXX0N0", authDomain: "furnicohub.firebaseapp.com", projectId: "furnicohub", storageBucket: "furnicohub.firebasestorage.app", messagingSenderId: "395576125006", appId: "1:395576125006:web:a848f68053c69409ddc51f" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let user = null;
    let shopData = {};
    let shopOrders = [];
    let shopReviews = [];
    let shopMessages = [];
    let currentTab = 'Dashboard';
    let tempImages = [null, null, null]; 
    let discountType = 'amount';
    let marketItems = []; 

    const CATEGORIES = ["Living Room", "Bedroom", "Dining Room", "Kitchen", "Bathroom", "Study Room", "Kids Room", "Outdoor & Garden", "Office", "Other"];
    const TABS = [
        { id: 'Dashboard', icon: 'fa-chart-pie' },
        { id: 'Smart POS', icon: 'fa-calculator' },
        { id: 'Marketplace', icon: 'fa-store' },    
        { id: 'Profile', icon: 'fa-user-gear' },     
        { id: 'Get Verified', icon: 'fa-certificate' }, 
        { id: 'Open/Close', icon: 'fa-clock' },     
        { id: 'Products', icon: 'fa-couch' },       
        { id: 'My Webpage', icon: 'fa-globe' },     
        { id: 'Orders', icon: 'fa-box-open' },      
        { id: 'Messages', icon: 'fa-comments' },    
        { id: 'Reviews', icon: 'fa-star' }          
    ];

    auth.onAuthStateChanged(async u => {
        if (u) {
            user = u;
            document.getElementById('login-ui').classList.add('hidden');
            document.getElementById('dashboard-ui').classList.remove('hidden');
            await loadShopData();
        } else {
            document.getElementById('login-ui').classList.remove('hidden');
            document.getElementById('dashboard-ui').classList.add('hidden');
        }
    });

    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); }
    function logout() { auth.signOut(); }

    async function loadShopData() {
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists) {
            shopData = doc.data();
            currentTab = shopData.profileCompleted ? 'Dashboard' : 'Profile';
        } else {
            shopData = { role: 'seller', profileCompleted: false, isVerified: false, products: [], isOpen: false, emergencyClose: false, schedule: {}, specialDates: [] };
            await db.collection('users').doc(user.uid).set(shopData);
            currentTab = 'Profile';
        }
        
        db.collection('users').doc(user.uid).collection('orders').orderBy('time', 'desc').onSnapshot(snap => {
            shopOrders = snap.docs.map(d => ({id:d.id, ...d.data()}));
            if(currentTab === 'Orders' || currentTab === 'Dashboard') renderContent();
        });

        db.collection('users').doc(user.uid).collection('reviews').onSnapshot(snap => {
            shopReviews = snap.docs.map(d => ({id:d.id, ...d.data()}));
            if(currentTab === 'Reviews' || currentTab === 'Dashboard') renderContent();
        });

        // Load Messages for Contact Form
        db.collection('users').doc(user.uid).collection('messages').orderBy('time', 'desc').onSnapshot(snap => {
            shopMessages = snap.docs.map(d => ({id:d.id, ...d.data()}));
            if(currentTab === 'Messages' || currentTab === 'Dashboard') renderContent();
        });

        renderTabs();
        renderContent();
    }

    function renderTabs() {
        const nav = document.getElementById('tabs-nav');
        let html = TABS.map(t => `<button class="tab-btn ${currentTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')"><i class="fa-solid ${t.icon}"></i> ${t.id}</button>`).join('');
        nav.innerHTML = html;
    }

    function switchTab(id) {
        if(!shopData.profileCompleted && id !== 'Profile') return alert("Please complete Profile first!");
        currentTab = id;
        renderTabs();
        renderContent();
    }

    function renderContent() {
        const c = document.getElementById('content-area');
        c.innerHTML = '';
        switch(currentTab) {
            case 'Dashboard': renderHome(c); break;
            case 'Smart POS': renderPOS(c); break;
            case 'Marketplace': renderMarketplace(c); break;
            case 'Profile': renderProfile(c); break;
            case 'Get Verified': renderVerify(c); break;
            case 'Open/Close': renderOpenClose(c); break;
            case 'Products': renderProducts(c); break;
            case 'My Webpage': renderWebpage(c); break;
            case 'Orders': renderOrders(c); break;
            case 'Messages': renderMessages(c); break;
            case 'Reviews': renderReviews(c); break;
        }
    }

    function renderHome(div) {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const todaysOrders = shopOrders.filter(o => o.time.startsWith(today)).length;
        const pendingReviews = shopReviews.filter(r => r.status !== 'published').length;
        const isOpen = !shopData.emergencyClose && (shopData.isOpen || false); 

        div.innerHTML = `
            <div class="card flex space-between" style="background:var(--primary); color:white; border:none;">
                <div id="live-clock" style="font-size:1.2rem; font-weight:bold;">Loading...</div>
                <div style="font-size:0.9rem;">${now.toDateString()}</div>
            </div>
            <div class="card flex space-between" style="border-left:5px solid ${isOpen?'var(--green)':'var(--red)'}">
                <div>
                    <h3 style="margin:0; color:${isOpen?'var(--green)':'var(--red)'}">${isOpen ? 'Shop is Open' : 'Shop is Closed'}</h3>
                    <small>Based on schedule</small>
                </div>
                <button class="btn btn-sm btn-outline" onclick="switchTab('Open/Close')">Edit</button>
            </div>
            <div class="stat-grid">
                <div class="stat-card" style="border-bottom:4px solid var(--primary);">
                    <h2>${todaysOrders}</h2>
                    <small>Orders Today</small>
                    <button class="btn btn-sm btn-outline mt-1" onclick="switchTab('Orders')">See</button>
                </div>
                <div class="stat-card" style="border-bottom:4px solid var(--gold);">
                    <h2>${shopMessages.length}</h2>
                    <small>Messages</small>
                    <button class="btn btn-sm btn-outline mt-1" onclick="switchTab('Messages')">See</button>
                </div>
            </div>
        `;
        
        if(window.clockInterval) clearInterval(window.clockInterval);
        window.clockInterval = setInterval(() => {
            const el = document.getElementById('live-clock');
            if(el) el.innerText = new Date().toLocaleTimeString();
        }, 1000);
    }

    function renderPOS(div) {
        div.innerHTML = `
            <div class="card">
                <h3>Smart POS</h3>
                <div class="input-group"><label>Product</label>
                    <select id="pos-item" onchange="calcPos()">
                        <option value="0|Select">Select...</option>
                        ${(shopData.products||[]).map(p => `<option value="${p.price}|${p.name}">${p.name} - Rs.${p.price}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group"><label>Customer</label><input id="pos-cust"></div>
                <div class="input-group"><label>Discount</label>
                    <div class="toggle-switch"><div class="toggle-opt ${discountType==='amount'?'active':''}" onclick="setDiscType('amount')">Rs.</div><div class="toggle-opt ${discountType==='percent'?'active':''}" onclick="setDiscType('percent')">%</div></div>
                    <input type="number" id="pos-disc" value="0" oninput="calcPos()">
                </div>
                <div class="text-center" style="margin:20px 0; background:#FFF3E0; padding:15px; border-radius:12px;">
                    <span style="font-size:1.8rem; font-weight:800; color:var(--primary);" id="pos-total">Rs. 0</span>
                </div>
                <button class="btn btn-green" onclick="printInv()">Print Invoice</button>
            </div>`;
    }
    
    function setDiscType(type) { discountType = type; renderPOS(document.getElementById('content-area')); calcPos(); }
    function calcPos() {
        const val = document.getElementById('pos-item').value.split('|')[0];
        const price = parseInt(val) || 0;
        const discVal = parseInt(document.getElementById('pos-disc').value) || 0;
        let final = discountType === 'amount' ? price - discVal : price - (price * (discVal / 100));
        document.getElementById('pos-total').innerText = "Rs. " + Math.max(0, final);
    }
    function printInv() { window.print(); }

    async function renderMarketplace(div) {
        div.innerHTML = `<div class="card"><h3>Feed</h3><input id="search-all" placeholder="Search..." class="w-100" onkeyup="filterFeed()"></div><div id="feed-grid" style="display:grid; gap:10px;">Loading...</div>`;
        try {
            const snap = await db.collection('users').where('role', '==', 'seller').get();
            marketItems = [];
            snap.forEach(doc => { const d = doc.data(); (d.products||[]).forEach(p => marketItems.push({...p, seller:d.shopName, sellerId:doc.id})); });
            filterFeed();
        } catch(e) { document.getElementById('feed-grid').innerHTML = 'Error'; }
    }
    window.filterFeed = function() {
        const s = document.getElementById('search-all').value.toLowerCase();
        const grid = document.getElementById('feed-grid');
        grid.innerHTML = marketItems.filter(i => i.name.toLowerCase().includes(s) || i.seller.toLowerCase().includes(s)).map(i => `
            <div class="card" onclick="window.open('shop.html?id=${i.sellerId}','_blank')"><b>${i.name}</b><br>Rs. ${i.price}<br><small>${i.seller}</small></div>`).join('');
    }

    function renderProfile(div) {
        const d = shopData;
        const lock = d.isVerified ? 'disabled' : '';
        div.innerHTML = `
            <div class="card">
                <h3>Shop Profile</h3>
                ${d.isVerified ? '<div class="text-center text-green mb-1"><b><i class="fa-solid fa-lock"></i> Profile Locked (Verified)</b></div>' : ''}
                <div class="text-center mb-1">
                    <img id="p-logo" src="${d.logo||'logo.png'}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--primary);">
                    ${!d.isVerified ? `<br><label class="btn btn-outline btn-sm mt-1">Upload Logo <input type="file" hidden onchange="upImg(this, 'logo')"></label>` : ''}
                </div>
                <div class="input-group"><label>Shop Name *</label><input id="s-name" value="${d.shopName||''}" ${lock}></div>
                <div class="input-group"><label>Address *</label><textarea id="s-addr" ${lock}>${d.address||''}</textarea></div>
                <div class="input-group"><label>Owner Name *</label><input id="s-own" value="${d.ownerName||''}" ${lock}></div>
                <div class="input-group"><label>NIC *</label><input id="s-nic" value="${d.nic||''}" ${lock}></div>
                <div class="input-group"><label>Phone 1 *</label><input type="number" id="s-ph1" value="${d.phone1||''}" ${lock}></div>
                <div class="input-group"><label>WhatsApp (+94...) *</label><input id="s-wa" type="number" value="${d.whatsapp||''}" placeholder="94771234567" ${lock}></div>
                ${!d.isVerified ? `<button class="btn" onclick="saveProfile(this)">Save Profile</button>` : ''}
            </div>
        `;
    }

    async function saveProfile(btn) {
        const name = document.getElementById('s-name').value;
        const addr = document.getElementById('s-addr').value;
        const own = document.getElementById('s-own').value;
        const nic = document.getElementById('s-nic').value;
        const ph1 = document.getElementById('s-ph1').value;
        const wa = document.getElementById('s-wa').value;

        if(!name || !addr || !own || !nic || !ph1 || !wa) return alert("All fields are required!");
        if(wa.length < 11 || !wa.startsWith('94')) return alert("WhatsApp number must start with 94 and have proper length (e.g. 94771234567)");

        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        try {
            await db.collection('users').doc(user.uid).update({
                shopName: name, address: addr, ownerName: own, nic: nic, phone1: ph1, whatsapp: wa,
                logo: shopData.temp_logo || shopData.logo || '',
                profileCompleted: true
            });
            shopData = (await db.collection('users').doc(user.uid).get()).data();
            alert("Saved! Check your Shop page.");
            switchTab('Dashboard');
        } catch(e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function renderVerify(div) {
        if(shopData.isVerified) return div.innerHTML = `<div class="card text-center" style="padding:40px;"><h1 style="color:var(--green)">Verified!</h1></div>`;
        div.innerHTML = `
            <div class="card">
                <h3>Get Verified (Rs. 5000)</h3>
                <button class="btn btn-outline" onclick="window.print()">Download Profile PDF</button>
                <div class="mt-1 mb-1 p-2" style="background:#FFF3E0; border-radius:8px;">Bank: Commercial Bank<br>Acc: 8750053306 (Colombage SD)</div>
                <div class="input-group"><label>Upload Certified Doc</label><div class="upload-box" onclick="document.getElementById('v-doc').click()">Upload<input type="file" id="v-doc" hidden onchange="upImg(this, 'doc')"></div></div>
                <div class="input-group"><label>Upload Payment Slip</label><div class="upload-box" onclick="document.getElementById('v-slip').click()">Upload<input type="file" id="v-slip" hidden onchange="upImg(this, 'slip')"></div></div>
                <button class="btn btn-green" onclick="subVerify(this)">Submit</button>
            </div>`;
    }
    
    async function subVerify(btn) {
        if(!shopData.temp_doc || !shopData.temp_slip) return alert("Upload proofs");
        btn.disabled = true;
        try {
            await db.collection('admin_requests').add({ uid: user.uid, shopName: shopData.shopName, doc: shopData.temp_doc, slip: shopData.temp_slip, time: new Date().toISOString() });
            alert("Submitted!");
        } catch(e) { alert(e.message); }
        btn.disabled = false;
    }

    function renderOpenClose(div) {
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const sch = shopData.schedule || {};
        div.innerHTML = `
            <div class="card" style="border:2px solid ${shopData.emergencyClose?'red':'green'}">
                <h3>Emergency</h3>
                <button class="btn btn-${shopData.emergencyClose?'green':'red'}" onclick="toggleEmg(!${shopData.emergencyClose})">${shopData.emergencyClose?'Open Shop':'Close Today'}</button>
            </div>
            <div class="card">
                <h3>Schedule</h3>
                ${days.map(d => `<div class="day-row"><div style="width:80px;">${d}</div><select id="st-${d}"><option value="open" ${sch[d]?.open?'selected':''}>Open</option><option value="closed" ${!sch[d]?.open?'selected':''}>Closed</option></select><input type="time" id="s-${d}" value="${sch[d]?.start||'09:00'}"><input type="time" id="e-${d}" value="${sch[d]?.end||'18:00'}"></div>`).join('')}
                <button class="btn" onclick="saveSch()">Save Schedule</button>
            </div>`;
    }

    async function toggleEmg(state) { await db.collection('users').doc(user.uid).update({emergencyClose:state}); shopData.emergencyClose=state; renderOpenClose(document.getElementById('content-area')); }
    async function saveSch() {
        const schedule = {};
        ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"].forEach(d => {
            schedule[d] = { open: document.getElementById(`st-${d}`).value === 'open', start: document.getElementById(`s-${d}`).value, end: document.getElementById(`e-${d}`).value };
        });
        await db.collection('users').doc(user.uid).update({schedule});
        alert("Saved");
    }

    function renderProducts(div) {
        tempImages = [null,null,null];
        div.innerHTML = `
            <div class="card">
                <h3>Add Product</h3>
                <div class="input-group"><label>Images</label><div class="flex">${[0,1,2].map(i=>`<div class="upload-box" style="padding:5px; width:60px;" onclick="document.getElementById('fp${i}').click()">+<input type="file" id="fp${i}" hidden onchange="upImg(this,'prod',${i})"><img id="pp${i}"></div>`).join('')}</div></div>
                <div class="input-group"><label>Category</label><select id="p-cat">${CATEGORIES.map(c=>`<option>${c}</option>`)}</select></div>
                <div class="input-group"><label>Name</label><input id="p-name"></div>
                <div class="input-group"><label>Description</label><textarea id="p-desc"></textarea></div>
                <div class="input-group"><label>Price</label><input type="number" id="p-price"></div>
                <button class="btn" onclick="saveProd(this)">Add Product</button>
            </div>
            <h3>Inventory</h3>
            ${(shopData.products||[]).map((p,i)=>`<div class="card flex space-between"><div class="flex"><img src="${p.images[0]}" style="width:40px;height:40px;"><div><b>${p.name}</b><br>Rs. ${p.price}</div></div><button class="btn btn-outline btn-sm" style="color:red; border-color:red" onclick="delProd(${i})">Del</button></div>`).join('')}
        `;
    }

    async function saveProd(btn) {
        const imgs = tempImages.filter(x=>x);
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        if(!imgs.length || !name || !price) return alert("Fill details");
        btn.disabled = true;
        const prod = { id:Date.now(), category:document.getElementById('p-cat').value, name, desc:document.getElementById('p-desc').value, price:Number(price), images:imgs };
        const newArr = [...(shopData.products||[]), prod];
        await db.collection('users').doc(user.uid).update({products:newArr});
        shopData.products = newArr;
        alert("Added"); renderProducts(document.getElementById('content-area'));
    }
    
    async function delProd(i) {
        if(confirm("Delete?")) { shopData.products.splice(i,1); await db.collection('users').doc(user.uid).update({products:shopData.products}); renderProducts(document.getElementById('content-area')); }
    }

    function renderWebpage(div) {
        const path = window.location.pathname.replace('dashboard.html', 'shop.html');
        const url = `${window.location.origin}${path}?id=${user.uid}`;
        div.innerHTML = `
            <div class="card text-center">
                <h3>Your Shop Link</h3>
                <input value="${url}" readonly class="w-100 mb-1" style="background:#eee; border:none; padding:10px;">
                <a href="${url}" target="_blank" class="btn">Open Page</a>
            </div>
            <div class="card">
                <h3>Visuals</h3>
                <div class="input-group"><label>Hero Text</label><input id="w-txt" value="${shopData.heroText||''}" onchange="upWeb()"></div>
            </div>`;
    }
    function upWeb() { db.collection('users').doc(user.uid).update({heroText:document.getElementById('w-txt').value}); }

    function renderOrders(div) {
        div.innerHTML = shopOrders.length ? shopOrders.map(o => `
            <div class="card">
                <div class="flex space-between"><b>${o.custName}</b> <small>${o.time.split('T')[0]}</small></div>
                <div class="flex space-between mt-1"><b class="text-primary">Rs. ${o.total}</b> <a href="https://wa.me/${o.custWa}" class="btn btn-green btn-sm">WhatsApp</a></div>
                <p style="font-size:0.8rem; margin:5px 0;">${(o.items||[]).map(i=>i.name).join(', ')}</p>
            </div>`).join('') : '<div class="card text-center">No Orders</div>';
    }

    function renderMessages(div) {
        if(!shopMessages.length) return div.innerHTML = `<div class="card text-center"><h3>Messages</h3><p>No messages from contact form yet.</p></div>`;
        div.innerHTML = shopMessages.map(m => `
            <div class="card">
                <div class="flex space-between"><b>${m.name}</b> <small>${new Date(m.time).toLocaleDateString()}</small></div>
                <p style="background:#f9f9f9; padding:10px; border-radius:8px; margin:5px 0;">${m.message}</p>
                <div class="flex space-between">
                    <div>Phone: ${m.phone}</div>
                    <a href="https://wa.me/${m.wa}" target="_blank" class="btn btn-green btn-sm"><i class="fa-brands fa-whatsapp"></i> Reply</a>
                </div>
            </div>
        `).join('');
    }

    function renderReviews(div) {
        div.innerHTML = shopReviews.map(r => `
            <div class="card">
                <div class="flex space-between"><b>${r.name}</b> <b style="color:var(--gold)">${'â˜…'.repeat(r.stars)}</b></div>
                <p>"${r.text}"</p>
                <div class="flex space-between">
                    <span class="text-${r.status==='published'?'green':'red'}">${r.status||'Pending'}</span>
                    <div class="flex">${r.status!=='published'?`<button class="btn btn-green btn-sm" onclick="pubRev('${r.id}')">Publish</button>`:''} <button class="btn btn-outline btn-sm" onclick="delRev('${r.id}')">Del</button></div>
                </div>
            </div>`).join('') || '<div class="card">No Reviews</div>';
    }
    
    function pubRev(id) { db.collection('users').doc(user.uid).collection('reviews').doc(id).update({status:'published'}); }
    function delRev(id) { if(confirm("Del?")) db.collection('users').doc(user.uid).collection('reviews').doc(id).delete(); }

    function upImg(input, type, idx) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const scale = 600/img.width; cvs.width=600; cvs.height=img.height*scale;
                cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                storage.ref(`img/${user.uid}/${Date.now()}.jpg`).putString(cvs.toDataURL('image/jpeg',0.7), 'data_url').then(s => s.ref.getDownloadURL().then(url => {
                    if(type==='logo') { shopData.temp_logo = url; document.getElementById('p-logo').src = url; }
                    else if(type==='doc') { shopData.temp_doc = url; alert("Uploaded"); }
                    else if(type==='slip') { shopData.temp_slip = url; alert("Uploaded"); }
                    else if(type==='prod') { tempImages[idx] = url; document.getElementById(`pp${idx}`).src = url; document.getElementById(`pp${idx}`).style.display='block'; }
                }));
            }
        }
    }
</script>
</body>
</html>
